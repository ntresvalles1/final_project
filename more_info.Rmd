---
title: "In-depth Analysis"
author: "Nicole Tresvalles, Karen Galvan"
date: "Last updated on `r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: kable
---

<!-- put space -->
<p>&nbsp;</p>
# SECTION NAME

Write your "more information" section here.

## Subsection name

Write a second `more_info.html` page going more in-depth for people who want more details. In should have

1. Between 2-3 more visualizations.
2. No more than 500 words of text


To start, we wanted to know where bike accidents are happening. 
```{r, echo = FALSE, message = FALSE, warning=FALSE}
bicycle_accidents <- read_csv('accidents_bicyclists_.csv')

#Filters out bike accidents without proper latitude/longitude--------------
bike_accidents_location <- bicycle_accidents %>% 
  left_join(people_injured, id="COLLISION_ID", na.rm=TRUE) %>% 
  filter(!is.na(LATITUDE), !is.na(LONGITUDE), LOCATION !=	"(0.0, 0.0)") %>% 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = st_crs(4326))

#Fixes wrong date on the CRASH.DATE column--------------
bike_accidents_location <- bike_accidents_location %>% 
  mutate(CRASH.DATE=CRASH_DATE) 

#Formats date correctly on the CRASH.DATE variable--------------
bike_accidents_location$CRASH.DATE <- as.Date(bike_accidents_location$CRASH.DATE, format = '%m/%d/%Y')

#Creates month and year variables--------------
bike_accidents_location <- bike_accidents_location %>% 
  mutate(month = month(CRASH.DATE), year = year(CRASH.DATE))

#Counts accidents in each nta--------------
borough_accidents <- nyc_point_poly(bike_accidents_location, "nta") %>%
  st_set_geometry(NULL) %>%
  group_by(year) %>%
  count(nta_name, nta_id) %>%
  rename(count = n)

#Creates maps for each borough--------------
nyc_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("queens", "brooklyn", "staten island", "bronx", "manhattan")
  )

mn_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("manhattan")
  )

qns_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("queens")
  )

bk_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("brooklyn")
  )

stat_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("staten island")
  )

bx_ntas <- nyc_boundaries(
  geography = "nta",
  filter_by = "borough",
  region = c("bronx")
  )

#Joins map of all boroughs with accident data--------------
bike_borough_accidents_final <- left_join(borough_ntas, borough_accidents)

#Filters previous df for '19,'20,'21 and non NA data--------------
bike_borough_accidents_final <- bike_borough_accidents_final %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

#Because we couldn't make a map that could facet and scale the individual boroughs
#using the original 'borough_accidents' df, (coord_sf doesn't support scale=free) we made individual dfs for each borough

#Creates dfs for each borough, filters for '19,'20,'21 and non NA data--------------
nyc_accidents <- left_join(nyc_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

nyc_qt <- classIntervals(c(min(nyc_accidents$count), nyc_accidents$count), n = 5, style = "pretty")
nyc_accidents <- nyc_accidents %>% 
  mutate(accident_count = cut(count, nyc_qt$brks))

```


<!-- put space -->
<p>&nbsp;</p>
## Leaflet Map of Bicycle Trails
```{r, echo = FALSE, message = FALSE, warning = FALSE}
#Transform into leaflet--------------
nyc_biketrails_leaflet <- st_transform(bike_routes, 4326)
bike_accidents_leaflet_sf <- st_transform(nyc_accidents, 4326)

bins <- c(0, 20, 40, 60, Inf)
pal <- colorBin(palette = "OrRd", domain = bike_accidents_leaflet_sf$count, bins = bins)

#Choropleth Map for Accidents with Bike Trails
bike_accidents_leaflet <- leaflet(bike_accidents_leaflet_sf) %>%
   addProviderTiles(providers$CartoDB.Positron) %>% 
   addPolygons(fillColor = ~pal(bike_accidents_leaflet_sf$count), 
               color = "black", weight = 1, dashArray = 2, fillOpacity = 1, opacity = 0.5) %>% 
   addPolygons(data = nyc_biketrails_leaflet, color = "purple",
               opacity = 0.7, weight = 0.5, fillOpacity = 0.2) %>% 
    addLegend("bottomright", pal = pal, values = ~count,
    title = "Bicycle Accidents in NYC", opacity = 1)

bike_accidents_leaflet
```

<!-- put space -->
<p>&nbsp;</p>
## Choropleth Map of Each Borough
```{r, echo = FALSE, message = FALSE, warning = FALSE}
mn_accidents <- left_join(mn_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

mn_qt <- classIntervals(c(min(mn_accidents$count), mn_accidents$count), n = 5, style = "pretty")
mn_accidents <- mn_accidents %>%
  mutate(accident_count = cut(count, mn_qt$brks))


qns_accidents <- left_join(qns_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

qns_qt <- classIntervals(c(min(qns_accidents$count), qns_accidents$count), n = 5, style = "pretty")
qns_accidents <- qns_accidents %>% 
  mutate(accident_count = cut(count, qns_qt$brks))



bk_accidents <- left_join(bk_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

bk_qt <- classIntervals(c(min(bk_accidents$count), bk_accidents$count), n = 5, style = "pretty")
bk_accidents <- bk_accidents %>% 
  mutate(accident_count = cut(count, bk_qt$brks))



stat_accidents <- left_join(stat_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

stat_qt <- classIntervals(c(min(stat_accidents$count), stat_accidents$count), n = 5, style = "pretty")
stat_accidents <- stat_accidents %>% 
  mutate(accident_count = cut(count, stat_qt$brks))



bx_accidents <- left_join(bx_ntas, borough_accidents) %>% 
  filter(year=="2019" | year=="2020" | year=="2021")

bx_qt <- classIntervals(c(min(bx_accidents$count), bx_accidents$count), n = 5, style = "pretty")
bx_accidents <- bx_accidents %>% 
  mutate(accident_count = cut(count, bx_qt$brks))

#Creates maps for each borough dataframe-------------------------------------
#ggplot() +
 # geom_sf(data=nyc_ntas) +
  #geom_sf(data= nyc_accidents, aes(fill = accident_count), size = 0.5) +
  #theme(panel.background = element_rect(fill = "aliceblue")) +
  #facet_grid(~ borough_name) + 
  #geom_sf(data = bike_routes, col = "black", fill = NA) +
  #scale_fill_brewer(palette = "OrRd") +
  #labs(fill="Accident frequency",title="Bike accidents in NYC", subtitle = "Organized by neighborhood tabulation areas") +
  #theme(axis.text.x = element_blank(),
   #    axis.text.y = element_blank(),
    #    axis.ticks = element_blank(),
     #   rect = element_blank())

```


### Manhattan
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Manhattan-------------------------------------
ggplot() +
  geom_sf(data= mn_ntas) +
  geom_sf(data= mn_accidents, aes(fill = accident_count), size = 0.5) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  facet_grid(~ year) +
  scale_fill_brewer(palette = "OrRd") +
  labs(fill="Accident frequency",title="Bike accidents in Manhattan", subtitle = "Organized by neighborhood tabulation area") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())
```


### The Bronx
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Bronx-------------------------------------
ggplot() +
  geom_sf(data= bx_ntas) +
  geom_sf(data= bx_accidents, aes(fill = accident_count), size = 0.5) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  facet_grid(~ year)+ 
  scale_fill_brewer(palette = "OrRd") +
  labs(fill="Accident frequency",title="Bike accidents in the Bronx", subtitle = "Organized by neighborhood tabulation area") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())
```


### Queens
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Queens (best borough)-------------------------------------
ggplot() +
  geom_sf(data=qns_ntas) +
  geom_sf(data= qns_accidents, aes(fill = accident_count)) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  facet_grid(~ year)+ 
  scale_fill_brewer(palette = "OrRd") +
  labs(fill="Accident frequency",title="Bike accidents in Queens", subtitle = "Organized by neighborhood tabulation area") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())
```

### Brooklyn
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Brooklyn-------------------------------------
ggplot() +
  geom_sf(data=bk_ntas) +
  geom_sf(data= bk_accidents, aes(fill = accident_count), size = 0.5) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  facet_grid(~ year)+ 
  scale_fill_brewer(palette = "OrRd") +
  labs(fill="Accident frequency",title="Bike accidents in Brooklyn", subtitle = "Organized by neighborhood tabulation area") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())
```


### Staten Island
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Staten Island-------------------------------------
ggplot() +
  geom_sf(data= stat_ntas) +
  geom_sf(data= stat_accidents, aes(fill = accident_count), size = 0.5) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  facet_grid(~ year)+ 
  scale_fill_brewer(palette = "OrRd") +
  labs(fill="Accident frequency",title="Bike accidents in Staten Island", subtitle = "Organized by neighborhood tabulation area") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank())

```




## When are these accidents happening?
```{r, echo = FALSE, message = FALSE, warning=FALSE}
# NYC Bicycle Accidents in 2019, 2020, & 2021--------------------------------
bike_borough_accidents_tibble <- st_set_geometry(bike_accidents_location, NULL) %>% 
  mutate(MonthName = month.abb[month])

bike_accidents_tibble_2019 <- bike_borough_accidents_tibble %>% 
  filter(year == "2019") 
bike_accidents_tibble_2020 <- bike_borough_accidents_tibble %>% 
  filter(year == "2020")
bike_accidents_tibble_2021 <- bike_borough_accidents_tibble %>% 
  filter(year == "2021")

accidents_2019 <- ggplot(bike_accidents_tibble_2019, 
                         aes(x = factor(MonthName,levels=month.abb), fill = factor(MonthName)))+ 
  geom_bar() +
  labs(x = NULL, y = NULL) +
  theme(plot.title = element_text(size = 12, hjust = 0.5), 
        axis.line = element_line(colour = "darkblue", size = 1, linetype = "solid")) + 
  ggtitle("Bicycle Accidents in 2019") +
  scale_y_continuous(limits=c(0, 800)) +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set3")

accidents_2020 <- ggplot(bike_accidents_tibble_2020, 
                         aes(x = factor(MonthName,levels=month.abb), fill = factor(MonthName))) + 
  geom_bar() +
  labs(x = NULL, y = NULL) +
  theme(plot.title = element_text(size = 12, hjust = 0.5), 
        axis.line = element_line(colour = "darkblue", size = 1, linetype = "solid")) + 
  ggtitle("Bicycle Accidents in 2020") +
  scale_y_continuous(limits=c(0, 800)) +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set3")

accidents_2021 <- ggplot(bike_accidents_tibble_2021, 
                         aes(x = factor(MonthName,levels=month.abb), fill = factor(MonthName))) + 
  geom_bar() +
  labs(x = NULL, y = NULL) +
  theme(plot.title = element_text(size = 12, hjust = 0.5), axis.line = element_line(colour = "darkblue", 
                      size = 1, linetype = "solid")) + 
  ggtitle("Bicycle Accidents in 2021") +
  scale_y_continuous(limits=c(0, 800)) +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set3")

#Patchwork into one-------------------------------------
accident_19_20 <- accidents_2019 /accidents_2020
all_accident <- accident_19_20 / accidents_2021 +
  theme(plot.margin = margin(5.5, 5.5, 5.5, 35)) 

all <- patchwork::patchworkGrob(all_accident)
gridExtra::grid.arrange(all, left = "Number of Bicyclist Injured", bottom = "Month")


```

<!-- put space -->
<p>&nbsp;</p>
# Why are these accidents happening?
```{r, echo = FALSE, message = FALSE, warning=FALSE}
#Gathers top 6 factors for collision------------------------------------
accident_factors_19 <- bike_accidents_tibble_2019 %>% 
  group_by(CONTRIBUTING.FACTOR.VEHICLE.1) %>%
  summarise(count = n()) %>% 
  top_n(11) 


accident_factors_20 <- bike_accidents_tibble_2020 %>% 
  group_by(CONTRIBUTING.FACTOR.VEHICLE.1) %>%
  summarise(count = n()) %>% 
  top_n(11)

accident_factors_21 <- bike_accidents_tibble_2021 %>% 
  group_by(CONTRIBUTING.FACTOR.VEHICLE.1) %>%
  summarise(count = n()) %>% 
  top_n(11) 

#Deletes "unspecified" factors-------------------------------------------
accident_factors_19 <- accident_factors_19[-c(10),] 
accident_factors_20 <- accident_factors_20[-c(11),] 
accident_factors_21 <- accident_factors_21[-c(10),] 



#Bar graphs----------------------------------------------------------
ggplot(accident_factors_19, mapping=aes(x = reorder(CONTRIBUTING.FACTOR.VEHICLE.1, count), y=count)) + 
  geom_col(fill="light blue") + 
  coord_flip() 

ggplot(accident_factors_20, mapping=aes(x = reorder(CONTRIBUTING.FACTOR.VEHICLE.1, count), y=count)) + 
  geom_col(fill="light blue") + 
  coord_flip()

ggplot(accident_factors_21, mapping=aes(x = reorder(CONTRIBUTING.FACTOR.VEHICLE.1, count), y=count)) + 
  geom_col(fill="light blue") + 
  coord_flip()

```
